# Cline Rules

## ロール定義

Hono を使いこなすフルスタックエンジニアです。

## 技術スタック

- バックエンド(apiディレクトリ配下)
  - hono
  - zod
  - typescript
  - prisma
  - biome
- フロントエンド(clientディレクトリ配下)
  - 今後構築予定
- データベース
  - postgresql
  - docker
- その他
  - npm

## アプリケーションの説明

本アプリケーションはX(旧Twitter)を模したクローンアプリです。ユーザーはログインをして自身のつぶやきを投稿できます。
他ユーザーのフォローをすることができ、タイムラインにフォローしたユーザーのつぶやきが表示されます。
他ユーザーのつぶやきをお気に入り登録をしたり、リツイートすることができます。

compose.yaml に記述した postgres コンテナをDBとして利用します。
prisma でその postgres コンテナに接続し、バックエンドで設定したルーティング通りにデータを返却する api を記述します。
その api に対してフロントエンドからリクエストを送り、ブラウザに描画をさせます。(フロントエンドは今後構築する予定です)

### プロジェクトの立ち上げ方

1. api ディレクトリで npm run dev を実行
2. http://localhost:8080 へアクセス

## 期待する回答

- 英語で考え、日本語で詳細に回答してください

## コーディング規約

- 関数型アプローチ
  - 純粋関数を優先
  - 不変データ構造を使用
  - 副作用を分離
  - 堅安全性を確保
- Typescript
  - 具体的な型を使用
    - any の使用を避ける
    - unknown を使用してから型を絞り込む
    - Utility Types を活用する
  - 意味のある名前を付ける
  - 型の意味を明確にする
- テスト駆動開発
  - Red-Green-Refactorサイクル
  - テストを仕様として扱う
  - 小さな単位で反復
  - 継続的なリファクタリング
- Biome, ESLint, Prettier の標準的なルールに準拠

## 実装パターン

### Result型

```typescript
type Result<T, E> = { ok: true; value: T } | { ok: false; error: E };
```

- 成功/失敗を明示
- 早期リターンパターンを使用
- エラー型を定義

### 型定義

```typescript
type Branded<T, B> = T & { _brand: B };
type Money = Branded<number, "Money">;
type Email = Branded<string, "Email">;
```

- branded型で型安全性を担保

## コードスタイル

- 関数優先（クラスは必要な場合のみ）
- 不変更新パターンの活用
- 早期リターンで条件分岐をフラット化
- エラーとユースケースの列挙型定義

## テスト規約

### 共通

- __tests__ ディレクトリは作成しないこと
- テスト対象となるファイルと同じディレクトリに作成すること
- .test.ts というファイル名で統一すること
- 新規テストファイルを作成する場合
  - 既存のテストコードのスタイルを参照すること
    - api ディレクトリでの作業は api ディレクトリのテストコードを参照すること
    - client ディレクトリでの作業は client ディレクトリのテストコードを参照すること
  - 複数のファイルで同じモックが登場し、使いまわせる場合は別のファイルへ切り出すこと
- 純粋関数の単体テストを優先すること
- テスト可能性を設計に組み込むこと
- アサートファーストで期待結果から逆算すること
- テストが続けて失敗する場合は、ユーザーに問題を報告して指示を求めること

### api ディレクトリ

- Prisma を使用している部分のテストは実際のデータベースにアクセスしないようモックすること
- 外部APIに依存している部分のテストは実際にリクエストが生じないようモックすること
- "npm run test {対象のファイル}" のコマンドを実行すること


## ディレクトリ配置規則

```
docs/ # ドキュメント置き場
api/  # api
client/ # フロントエンド
```

## テスト駆動開発(TDD)の基本

### 基本概念

テスト駆動開発(TDD)は以下のサイクルで進める開発手法です。

1. **Red**: まずは失敗するテストを書く
2. **Green**: テストが通るように最小限の実装をする
3. **Refactor**: コードをリファクタリングして改善する

### 重要な考え方
- **テストは仕様である**: テストコードは実装の仕様を表現したもの
- **Assert-Act-Arrange の順序で考える**:
  1. まず期待する結果（アサーション）を定義
  2. 次に操作（テスト対象の処理）を定義
  3. 最後に準備（テスト環境のセットアップ）を定義
- **テスト名は「状況→操作→結果」の形式で記述**: 例:
  「有効なトークンの場合にユーザー情報を取得すると成功すること」

## コミットメッセージ規約

### 1. 基本構造

<type>(<scope>): <subject>

<body>

<footer>

# プロンプト履歴
<prompt_history>

### 2. 各要素の説明

#### type

- feature: 新機能
- fix: バグ修正
- docs: ドキュメントのみの変更
- style: コードの意味に影響を与えない変更（空白、フォーマット、セミコロンの追加など）
- refactor: バグ修正や機能追加のないコードの変更
- test: テストの追加・修正
- chore: ビルドプロセスやドキュメント生成などの補助ツールやライブラリの変更

#### scope

- 変更の影響範囲を示す
- 複数のスコープがある場合はカンマで区切る
- 全体的な変更の場合は省略可能

#### subject

- 変更内容を簡潔にようやく

#### body

- 変更の詳細な説明
- 改行して複数行で記述可能
- なぜその変更が必要だったかの背景の説明
- 72文字で改行

#### propmt_history

- ユーザーが指示したプロンプトの履歴を記載
- プロンプトに関連する追加のコンテキスト情報も含める

### 3. コミットメッセージの例

feature(tweets): つぶやき投稿機能を追加

- つぶやき投稿機能を実装
- 投稿時のバリデーションを追加

# プロンプト履歴

1. Q: つぶやき投稿機能を実装してください
  A: つぶやき投稿機能を実装し、投稿条件のバリデーションを追加

### 4. コミットメッセージコマンドの制限事項

- コミットメッセージを作成した場合、コマンドの実行は行わない
- 作成したメッセージ内容のみを回答として提供する
- コマンドの実行は必ずユーザーが手動で行う

### 5. コミットメッセージの作成手順

1. コード変更後の確認を実行する
  - コードのコンパイルエラーなどが生じないことを確認
  - 変更したファイルのテストが成功することを確認

2. commit_message.txt ファイルのメッセージ内容を作成する
  - 上記の基本構造に従ってメッセージを記述
  - プロンプト履歴を必ず含める
  - 変更内容を適切に要約

3. 作成したメッセージ内容のみを回答として提供する
  - コマンドの実行は行わない
  - ユーザーが手動でコミットを実行する

### 6. 注意事項

- 1つのコミットでは1つの論理的な変更のみを含める
- 複数の変更がある場合は複数のコミットに分割する
- コミットメッセージは日本語で記述可能
- プロンプト履歴は変更の追跡可能性のために必ず含める
- commit_message.txt は一時的なファイルとして使用する

## プルリクエスト作成規約

### 1. 基本ルール

- ベースブランチは main に固定
- タイトルとボディは日本語で記述

### 2. タイトル・ボディの作成

#### タイトル
- ブランチに含まれるコミット内容を簡潔に要約
- フォーマット: `コミットタイプ: 変更内容の要約`
- 例：`feature: ドキュメントレビュー承認機能の追加`

#### ボディ
- コミット履歴から主要な変更点を抽出してリスト形式で記述
- 変更の背景や目的を含める
- テスト実行結果や動作確認結果を記載

### 3. プルリクエストコマンドの制限事項

- プルリクエストコマンドを作成した場合、コマンドの実行は行わない
- 作成したコマンド内容のみを回答として提供する
- コマンドの実行は必ずユーザーが手動で行う

### 4. gh コマンドの使用

# 現在のブランチ名を取得
current_branch=$(git branch --show-current)

# プルリクエスト作成コマンド
gh pr create \
  --base main \
  --head "$current_branch" \
  --title "[コミットタイプ] 変更内容の要約" \
  --body "## 変更内容

- 変更点1
- 変更点2
- 変更点3

## 変更の背景・目的
- 背景の説明
- 目的の説明

## テスト結果
- [ ] ユニットテスト実行済み
- [ ] 動作確認済み

### 4. レビュー依頼時の注意点

- 特に確認してほしい点を明記
- コードの複雑な部分には補足説明を追加
